<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Ubuntu:300,300italic,400,400italic,700,700italic|Ubuntu:300,300italic,400,400italic,700,700italic|Ubuntu:300,300italic,400,400italic,700,700italic|Ubuntu:300,300italic,400,400italic,700,700italic|Ubuntu:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="mybatis," />










<meta name="description" content="MyBtis通过SQL Map将Java对象映射成SQL语句，将结果集转换成Java对象。与其他的ORM框架相比，解决了Java对象与查询结果集的映射，又能方便地编写SQL语句。">
<meta property="og:type" content="article">
<meta property="og:title" content="MyBatis架构及映射原理">
<meta property="og:url" content="http://example.com/2020/12/13/MyBatis%E6%9E%B6%E6%9E%84%E5%8F%8A%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="Doug-Wilson&#39;s blogs">
<meta property="og:description" content="MyBtis通过SQL Map将Java对象映射成SQL语句，将结果集转换成Java对象。与其他的ORM框架相比，解决了Java对象与查询结果集的映射，又能方便地编写SQL语句。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/MyBatis%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6.png">
<meta property="og:image" content="http://example.com/images/SqlSessionFactory%E7%9A%84%E7%94%9F%E6%88%90.png">
<meta property="article:published_time" content="2020-12-13T02:16:21.000Z">
<meta property="article:modified_time" content="2021-06-08T12:10:32.797Z">
<meta property="article:author" content="Doug-Wilson">
<meta property="article:tag" content="mybatis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/MyBatis%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/2020/12/13/MyBatis架构及映射原理/"/>





  <title>MyBatis架构及映射原理 | Doug-Wilson's blogs</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband">
		<a target="_blank" rel="noopener" href="https://your-url" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
	</div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Doug-Wilson's blogs</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">学无止境，积累技术</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-主页">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            主页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-关于">
          <a href="/about/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-标签">
          <a href="/tags/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-目录">
          <a href="/categories/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            目录
          </a>
        </li>
      
        
        <li class="menu-item menu-item-归类">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-时间表">
          <a href="/schedule/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br />
            
            时间表
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/13/MyBatis%E6%9E%B6%E6%9E%84%E5%8F%8A%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Doug-Wilson's blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MyBatis架构及映射原理</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-13T10:16:21+08:00">
                2020-12-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>MyBtis通过SQL Map将Java对象映射成SQL语句，将结果集转换成Java对象。与其他的ORM框架相比，解决了Java对象与查询结果集的映射，又能方便地编写SQL语句。</p>
<span id="more"></span>

<h2 id="MyBatis类核心组件"><a href="#MyBatis类核心组件" class="headerlink" title="MyBatis类核心组件"></a>MyBatis类核心组件</h2><blockquote>
<p>MyBatis总的来说，主要完成两件事：</p>
<ol>
<li>根据JDBC规范建立与数据库的连接</li>
<li>通过反射完成Java对象与数据库参数间相互转化的关系</li>
</ol>
</blockquote>
<p>MyBatis的核心组件分为4个部分：</p>
<ul>
<li>SqlSessionFactoryBuilder（构造器）：根据配置或者代码生成 <code>SqlSessionFactory</code> ，采用的设计模式是建造者模式，分布构建</li>
<li>SqlSessionFactory（工厂接口）： <code>SqlSessionFactory</code> 生成 <code>SqlSession</code>，使用的是工厂模式</li>
<li>SqlSession（会话）：既可以发送SQL语句执行并返回结果，也可以获取Mapper的接口。</li>
<li>SQL Mapper（映射器）：一个组件，由一个Java接口和XML文件（或注解）构成。需要给出相应接口方法的SQL和映射规则。负责发送SQL执行并返回接口。</li>
</ul>
<p><img src="/images/MyBatis%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6.png"></p>
<h3 id="SqlSessionFactory（工厂接口）"><a href="#SqlSessionFactory（工厂接口）" class="headerlink" title="SqlSessionFactory（工厂接口）"></a>SqlSessionFactory（工厂接口）</h3><p>MyBatis可以通过XML配置或者代码区生产 <code>SqlSessionFactory</code> 。<code>SqlSessionFactoryBuilder</code> 提供一个类 <code>org.apache.ibatis.session.Configuration</code> 作为引导，采用建造者模式，分步完成整个MyBatis上下文的构建。</p>
<p><code>SqlSessionFactory</code> 是一个接口，在MyBatis中有两个实现类：<code>SqlSessionManager</code> 和 <code>DefaultSqlSessionFactory</code> 。一般而言，具体实现为 <code>DefaultSqlSessionFactory</code> ，只不过 <code>SqlSessionManager</code> 用在多线程环境中，它的具体实现依靠 <code>DefaultSqlSessionFactory</code> 。</p>
<p><img src="/images/SqlSessionFactory%E7%9A%84%E7%94%9F%E6%88%90.png"></p>
<p>如上图所示，基于MyBatis的应用都是以 <code>SqlSessionFactory</code> 为中心，而 <code>SqlSessionFactory</code> 唯一的作用就是生产 <code>MyBatis</code> 的核心接口对象 <code>SqlSession</code> ，所以它的责任是唯一的，可以采用单例模式生成 <code>SqlSessionFactory</code> 。下面讨论基于XML构建和基于Java代码构建 <code>SqlSessionFactory</code> 。</p>
<h4 id="使用XML构建-SqlSessionFactory"><a href="#使用XML构建-SqlSessionFactory" class="headerlink" title="使用XML构建 SqlSessionFactory"></a>使用XML构建 SqlSessionFactory</h4><p>在MyBatis中的XML文件分为两类：</p>
<ol>
<li>基础配置文件。通常只有一个并且命名为 <code>mybatis-config.xml</code>，主要用于配置一些最基本的上下文参数和运行环境</li>
<li>映射文件。配置映射关系、SQL、参数等信息，通常和接口名称有关。</li>
</ol>
<p>这里介绍的是基础配置文件，下面是一个简易的基础配置文件，将其命名为 <code>mybatis-config.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span> </span></span><br><span class="line"><span class="meta">	<span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">	<span class="meta-string">&quot;httP://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--别名，配置成功后可以用别名代替全限定名--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">&quot;role&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.dougWilson.ssm.pojo.role&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--环境变量的配置，这里配置的是数据库--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">            	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">               	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/ssm&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;090900&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--映射器配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;com/dougWilson/ssm/mapper/RoleMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过Java代码生成 <code>SqlSessionFactory</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">null</span>;</span><br><span class="line">String resource = <span class="string">&quot;mybatis-config.xml&quot;</span>;</span><br><span class="line">InputStream inStream = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    inStream = Resources.getResourceAsStream(resource);</span><br><span class="line">    SqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inStream);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用代码创建SqlSessionFactory"><a href="#使用代码创建SqlSessionFactory" class="headerlink" title="使用代码创建SqlSessionFactory"></a>使用代码创建SqlSessionFactory</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据库连接池信息</span></span><br><span class="line">PooledDataSource dataSource = <span class="keyword">new</span> PooledDataSource();</span><br><span class="line">dataSource.setDriver(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">dataSource.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">dataSource.setPassword(<span class="string">&quot;090900&quot;</span>);</span><br><span class="line">dataSource.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/ssm&quot;</span>);</span><br><span class="line">dataSource.setDefaultAutoCommit(<span class="keyword">false</span>);</span><br><span class="line"><span class="comment">// 采用MyBatis的JDBC事务方式</span></span><br><span class="line">TransactionFactory transactionFactory = <span class="keyword">new</span> JdbcTransactionFactory();</span><br><span class="line">Environment environment = <span class="keyword">new</span> Environment(<span class="string">&quot;development&quot;</span>, transactionFactory, dataSource);</span><br><span class="line"><span class="comment">// 创建Configuration对象</span></span><br><span class="line">Configuration configuration = <span class="keyword">new</span> Configuration(environment);</span><br><span class="line"><span class="comment">// 注册一个MyBatis上下文别名</span></span><br><span class="line">configuration.getTypeAliasRegistry().registerAlias(<span class="string">&quot;role&quot;</span>, Role.class);</span><br><span class="line"><span class="comment">// 加入一个映射器</span></span><br><span class="line">configuration.addMapper(RoleMapper.class);</span><br><span class="line"><span class="comment">// 使用SqlSessionFactoryBuilder 构建 SqlSessionFactory</span></span><br><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(configuration);</span><br><span class="line"><span class="keyword">return</span> sqlSessionFactory;</span><br></pre></td></tr></table></figure>

<h3 id="SqlSession"><a href="#SqlSession" class="headerlink" title="SqlSession"></a>SqlSession</h3><p><code>SqlSession</code> 是MyBatis的核心接口，有两个实现类：<code>DefaultSqlSession</code> 和 <code>SqlSessionManager</code> 。在MyBatis中， <code>SqlSession</code> 作用就类似于一个JDBC中的 Connection 对象，代表一个连接资源的启用，具体来说，其作用有以下3个方面：</p>
<ol>
<li>获取 Mapper 接口</li>
<li>发送SQL给数据库</li>
<li>控制数据库事务</li>
</ol>
<p>创建一个 <code>SqlSession</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SqlSession sqlSession = SqlSessionFactory.openSession();</span><br></pre></td></tr></table></figure>

<p>获取到 <code>SqlSession</code> 后，调用其方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sqlSession.commit(); <span class="comment">// 提交事务</span></span><br><span class="line">sqlSession.rollback(); <span class="comment">// 回滚事务</span></span><br><span class="line">sqlSession.close(); <span class="comment">// 关闭资源</span></span><br></pre></td></tr></table></figure>

<h3 id="SQL-Mapper（映射器）"><a href="#SQL-Mapper（映射器）" class="headerlink" title="SQL Mapper（映射器）"></a>SQL Mapper（映射器）</h3><p>映射器是 <code>MyBatis</code> 中最重要、最复杂的组件，由一个接口和对应的XML文件组曾。可以配置如下内容：</p>
<ol>
<li>描述映射规则</li>
<li>提供SQL语句，并可以配置SQL参数类型、返回类型、缓存刷新等信息</li>
<li>配置缓存</li>
<li>提供动态SQL</li>
</ol>
<p>映射器常用的方式有两种，基于XML文件的形式和基于注解的形式。下面用一个实例具体介绍：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line">    <span class="comment">// 省略getter和setter方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>映射器的主要作用就是将SQL查询到的结果映射为一个POJO，或者将POJO的数据插入到数据库中，并定义一些关于缓存等的重要内容。</p>
<h4 id="基于XML定义的映射器"><a href="#基于XML定义的映射器" class="headerlink" title="基于XML定义的映射器"></a>基于XML定义的映射器</h4><p>用XML定义映射器分为两个部分：接口和XML。</p>
<p>映射器接口 <code>RoleMapper</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleMapper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Role <span class="title">getRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>XML文件 <code>RoleMapper.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">	<span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">	<span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.dougWilson.ssm.mapper.RoleMapper&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getRole&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;role&quot;</span>&gt;</span></span><br><span class="line">    	SELECT id, role_name as roleName, note FROM t_role WHERE id=#&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>有了这两个文件，就完成了一个映射器的定义。MyBatis默认提供自动映射，只要SQL返回的列名能和POJO类的属性对应即可。</p>
<h4 id="基于注解定义的映射器"><a href="#基于注解定义的映射器" class="headerlink" title="基于注解定义的映射器"></a>基于注解定义的映射器</h4><p>只需要一个接口就可以通过MyBatis的注解来注入SQL：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleMapper</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select id, role_name as roleName, note from t_role where id=#&#123;id&#125;&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Role <span class="title">getRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这完全等同于XML方式创建映射器。如果基于注解定义的映射器和基于XML方式定义的映射器同时定义，基于XML方式将覆盖掉基于注解的方式，说明官方推荐使用基于XML文件定义的映射器，为什么这样，下面讨论这个问题。</p>
<p>虽然看起来基于注解定义的映射器方式要简单许多，但这是因为上面例子的SQL语句比较简单。在工作和学习中，SQL的复杂度远远超过现在看到的SQL语句。比如:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_user u</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_user_role ur <span class="keyword">ON</span> ur.user_id<span class="operator">=</span>u.id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_role r <span class="keyword">ON</span> ur.role_id<span class="operator">=</span>r.id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_female_health fh <span class="keyword">ON</span> fh.user_id<span class="operator">=</span>u.id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_male_health mh <span class="keyword">ON</span> u.id<span class="operator">=</span>mh.user_id</span><br><span class="line"><span class="keyword">WHERE</span> u.user_name <span class="keyword">LIKE</span> concat(<span class="string">&#x27;%&#x27;</span>, $&#123;userName&#125;, <span class="string">&#x27;%&#x27;</span>)</span><br><span class="line"><span class="keyword">AND</span> r.role_name <span class="keyword">LIKE</span> concat(<span class="string">&#x27;%&#x27;</span>, $&#123;roleName&#125;,<span class="string">&#x27;%&#x27;</span>)</span><br><span class="line"><span class="keyword">AND</span> u.sex <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">AND</span> ui.head_image <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>

<p>很显然，这条SQL语句比较复杂，如果放入@Select中会明显增加注解的内容。如果把大量的SQL放入Java代码中，代码的可读性也会下降。如果同时还要考虑使用动态SQL，比如当参数 userName 为空，则不使用 <code>u.user_name LIKE concat(&#39;%&#39;, $&#123;userName&#125;, &#39;%&#39;)</code> 作为查询条件，这样就使得这个注解更加复杂，不利于日后的维护和修改。</p>
<p>此外，基于XML文件的映射器还可以相互引入，而注解则不可以，所以在一些比较复杂的场景下，使用XML方式会更加方便和灵活。</p>
<h3 id="发送SQL"><a href="#发送SQL" class="headerlink" title="发送SQL"></a>发送SQL</h3><h4 id="SqlSession发送SQL"><a href="#SqlSession发送SQL" class="headerlink" title="SqlSession发送SQL"></a>SqlSession发送SQL</h4><p>以上述例子为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Role role = (Role)sqlSession.selectOne(<span class="string">&quot;com.dougWilson.ssm.mapper.RoleMapper.getRole&quot;</span>, <span class="number">1L</span>);</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="comment">// Role role = (Role)sqlSession.selectOne(&quot;getRole&quot;, 1L);</span></span><br></pre></td></tr></table></figure>

<p><code>selectOne</code> 方法标识使用查询并且只返回一个对象，而参数是一个String对象和一个Object对象，这里是一个long类型的参数，long参数是它的主键。</p>
<h4 id="Mapper接口发送SQL"><a href="#Mapper接口发送SQL" class="headerlink" title="Mapper接口发送SQL"></a>Mapper接口发送SQL</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RoleMapper roleMapper = sqlSession.getMapper(RoleMapper.class);</span><br><span class="line">Role role = roleMapper.getRole(<span class="number">1L</span>);</span><br></pre></td></tr></table></figure>

<p>通过 <code>SqlSession</code> 的 <code>getMapper</code> 方法获取一个Mapper接口，就可以调用它的方法。因为XML文件或者接口注解定义的SQL都可以通过“类的全限定名+方法名” 查找，所以MyBatis会启用对应的SQL进行运行，并返回结果。</p>
<h4 id="两种发送SQL方式对比"><a href="#两种发送SQL方式对比" class="headerlink" title="两种发送SQL方式对比"></a>两种发送SQL方式对比</h4><p>两种方式都是依靠 <code>SqlSession</code> ，一种为直接发送，另一种通过 <code>SqlSession</code> 获取 <code>Mapper</code> 接口后再发送。建议采用 SqlSession 获取 Mapper 的方式，理由如下：</p>
<ol>
<li>使用Mapper接口编程可以消除 SqlSession 带来的功能性代码，提高可读性。而SqlSession发送SQL，需要一个SQL id去匹配SQL</li>
<li>使用Mapper接口，类似于 <code>roleMapper.getRole(1L)</code> 是完全面向对象的语言，更能体现业务逻辑</li>
<li>使用Mapper接口，编译的时候会提示错误和校验，而使用 <code>sqlSession.selectOne(...)</code> 的语法，只有再运行中才能知道是否会产生错误</li>
</ol>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><h4 id="SqlSessionFactoryBuilder"><a href="#SqlSessionFactoryBuilder" class="headerlink" title="SqlSessionFactoryBuilder"></a>SqlSessionFactoryBuilder</h4><p><code>SqlSessionFactoryBuilder</code> 的作用在于创建 <code>SqlSessionFactory</code> ，创建成功后， <code>SqlSessionFactoryBuilder</code> 便失去了作用，所以它只存在于创建 <code>SqlSessionFactory</code> 的方法中，而不要让其长期存在。</p>
<h4 id="SqlSessionFactory"><a href="#SqlSessionFactory" class="headerlink" title="SqlSessionFactory"></a>SqlSessionFactory</h4><p><code>SqlSessionFactory</code>可以被认为是一个数据库连接池，作用是创建 <code>SqlSession</code> 接口对象。因为 MyBatis 的本质是对数据库的操作，所以 <code>SqlSessionFactory</code> 的生命周期存在于整个 MyBatis 的应用之中，所以一旦创建了 <code>SqlSessionFactory</code>，就要长期保持它，知道不再使用 MyBatis 应用，所以可以认为 <code>SqlSessionFactory</code> 的生命周期等同于 MyBatis 的应用周期。</p>
<p>由于 <code>SqlSessionFactory</code> 是一个对数据库的连接池，所以它占据着数据库的连接资源。如果创建多个 <code>SqlSessionFactory</code>，那么就存在多个数据库连接池，这样不利于对数据库资源的控制，也会导致数据库连接资源被耗光，出现宕机的情况。因此，在一般的应用中，都将 <code>SqlSessionFactory</code> 作为一个单例，让它在应用中被共享。</p>
<h4 id="SqlSession-1"><a href="#SqlSession-1" class="headerlink" title="SqlSession"></a>SqlSession</h4><p><code>SqlSession</code> 相当于一个数据库连接（Connection对象），可以在一个事务里执行多条SQL，然后通过一些方法，提交或回滚事务。所以 <code>SqlSession</code> 的生命周期为一个业务请求，处理完一个请求后，就该关闭该连接，将其归还于 <code>SqlSessionFactory</code> ，否则数据库资源很快就会被耗费光。</p>
<h4 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h4><p>Mapper是一个接口，由 <code>SqlSession</code> 创建，由于 <code>SqlSession</code> 的关闭，它的数据库连接资源也会小时，所以其生命周期应小于等于 <code>SqlSession</code> 的生命周期，一旦处理完相关的业务，就该废弃它。</p>
<h2 id="MyBatis配置"><a href="#MyBatis配置" class="headerlink" title="MyBatis配置"></a>MyBatis配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span>		<span class="comment">&lt;!--配置--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span> /&gt;</span>	<span class="comment">&lt;!--属性--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span> /&gt;</span>	<span class="comment">&lt;!--设置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span> /&gt;</span>		<span class="comment">&lt;!--类型命名--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeHandlers</span> /&gt;</span>	<span class="comment">&lt;!--类型处理器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">objectFactory</span> /&gt;</span>	<span class="comment">&lt;!--对象工厂--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span> /&gt;</span>			<span class="comment">&lt;!--插件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span>&gt;</span>		<span class="comment">&lt;!--配置环境--&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">environment</span>&gt;</span>	<span class="comment">&lt;!--环境变量--&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">transactionManager</span> /&gt;</span>		<span class="comment">&lt;!--事务管理器--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> /&gt;</span>		<span class="comment">&lt;!--数据源--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">databaseIdProvider</span> /&gt;</span>		<span class="comment">&lt;!--数据库厂商标识--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span> /&gt;</span>			<span class="comment">&lt;!--映射器--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>需要注意，MyBatis配置项的顺序不能颠倒，如果颠倒了顺序，在MyBatis启动阶段就会发生异常，导致程序无法运行。下面讨论常用配置项：</p>
<h3 id="properties设置"><a href="#properties设置" class="headerlink" title="properties设置"></a>properties设置</h3><p><code>properties</code> 属性可以给系统配置一些运行参数，放在XML文件或者 <code>properties</code> 文件中，而不是放在Java代码中，这样的好处在于方便参数修改，而不会引起代码的重新编译。</p>
<p>MyBatis提供了3种方式使用 <code>properties</code>，分别为：</p>
<ul>
<li>property子元素</li>
<li>properties文件</li>
<li>Java代码</li>
</ul>
<h4 id="property子元素"><a href="#property子元素" class="headerlink" title="property子元素"></a>property子元素</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">	<span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">	<span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;database.driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;database.url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/ssm&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;database.username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;database.password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;090900&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">&quot;role&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.dougWilson.ssm.pojo.role&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">            	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;database.driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">               	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;database.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;database.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;database.password&#125;&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;com/dougWilson/ssm/mapper/RoleMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用 property 子元素的好处就是，定义一次就可以在文件中到处引用。缺点是，如果属性参数有许多个，使用这样的方式就不是一个好选择，这时候可以使用 properties 文件</p>
<h4 id="使用properties文件"><a href="#使用properties文件" class="headerlink" title="使用properties文件"></a>使用properties文件</h4><p>将多个键值对放在一个properties文件中，比如 <code>jdbc.properties</code> ，然后在需要相应键值对的地方引入文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">database.driver=com.mysql.cj.jdbc.Driver</span><br><span class="line">database.url=jdbc:mysql://localhost:3306/ssm</span><br><span class="line">database.username=root</span><br><span class="line">database.password=090900</span><br></pre></td></tr></table></figure>

<p>在MyBatis中通过 <code>&lt;properties&gt;</code> 属性resource来引入 <code>properties</code> 文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">&quot;jdbc.properties&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过 <code>$&#123;database.username&#125;</code> 的方法引入properties文件的属性参数到 MyBatis 配置文件中。 </p>
<h4 id="Java代码"><a href="#Java代码" class="headerlink" title="Java代码"></a>Java代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">String resource = <span class="string">&quot;mybatis-config.xml&quot;</span>;</span><br><span class="line"></span><br><span class="line">InputSream in = Resources.getResourceAsStream(<span class="string">&quot;jdbc.properties&quot;</span>);</span><br><span class="line">Properties pros = <span class="keyword">new</span> Properties();</span><br><span class="line">pros.load(in);</span><br><span class="line"></span><br><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(in, pros);</span><br></pre></td></tr></table></figure>

<h3 id="settings设置"><a href="#settings设置" class="headerlink" title="settings设置"></a>settings设置</h3><p><code>settings</code> 是MyBatis中最复杂的配置，能够深刻影响 MyBatis 底层的运行。大部分情况下使用默认配置的默认值就可以运行，只需要修改一些常用的规则，比如 自动映射、驼峰命名映射、级联规则、是否启动缓存、执行器类型。下面是使用方式：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;cacheEnabled&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;lazyLoadingEnabled&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>settings配置项：</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>作用</th>
<th>配置选项说明</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>cacheEnabled</td>
<td>所有映射器中配置缓存的全局开关</td>
<td>true|false</td>
<td>true</td>
</tr>
<tr>
<td>lazyLoadingEnabled</td>
<td>延迟加载的全局开关。开启时，所有关联对象都会延迟加载。在特定关联关系中可以通过设置 fetchType属性来覆盖该项的开关状态</td>
<td>true|false</td>
<td>false</td>
</tr>
<tr>
<td>aggressiveLazyLoading</td>
<td>当启用时，对任意延迟属性的调用会使带有延迟加载属性的对象完整加载；繁殖，每种属性会按需加载</td>
<td>true|false</td>
<td>版本3.4.1之前为true，之后为false</td>
</tr>
<tr>
<td>multipleResultSetsEnabled</td>
<td>是否允许单一语句返回多结果集（需要兼容驱动）</td>
<td>true|false</td>
<td>true</td>
</tr>
<tr>
<td>useColumnLabel</td>
<td>使用列标签代替列名。不同的驱动会有不同的表项，具体可以参考相关驱动文档或者通过测试这两种不同的模式来观察所用驱动的结果</td>
<td>true|false</td>
<td>true</td>
</tr>
<tr>
<td>useGeneratedKeys</td>
<td>允许JDBC支持自动生成主键，需要驱动兼容。如果设置为true，则这个设置强制使用自动生成主键，尽管一些驱动不能兼容但仍然可以正常工作</td>
<td>true|false</td>
<td>false</td>
</tr>
<tr>
<td>autoMappingBehavior</td>
<td>指定MyBatis应该如何自动映射列到字段或者属性。NONE标识取消自动映射；PARTIAL标识只会自动映射，没有定义嵌套结果集和映射结果集；FULL会自动映射任意复杂的结果集</td>
<td>NONE、PARTIAL、FULL</td>
<td>PARTIAL</td>
</tr>
<tr>
<td>autoMappingUnknownColumnBehavior</td>
<td>指定自动映射中未知列的行为。默认是不处理，只要当日志级别达到WARN级别或者以下，才会显式相关日志，如果失败会抛出SqlSessionException异常</td>
<td>NONE、WARNING、FAILING</td>
<td>NONE</td>
</tr>
<tr>
<td>defaultExecutorType</td>
<td>配置默认的执行器。SIMPLE是普通的执行器；REUSE会重用预处理语句；BATCH执行器将重用语句并执行批量更新</td>
<td>SIMPLE、REUSE、BATCH</td>
<td>SIMPLE</td>
</tr>
<tr>
<td>defaultStatementTimeout</td>
<td>设置超时事件，它决定驱动等待数据库响应的描述</td>
<td>任何正整数</td>
<td>Not Set(null)</td>
</tr>
<tr>
<td>defaultFetchSize</td>
<td>设置数据库驱动程序默认返回的条数限制，此参数可以重新设置</td>
<td>任何正整数</td>
<td>Not Set(null</td>
</tr>
<tr>
<td>safeRowBoundsEnabled</td>
<td>允许在嵌套语句中使用分页（RowBounds）。如果允许，设置false</td>
<td>true|false</td>
<td>false</td>
</tr>
<tr>
<td>safeResultHandlerEnabled</td>
<td>允许在嵌套语句中使用分页（ResultHandler）。如果允许，设置false</td>
<td>true|false</td>
<td>false</td>
</tr>
<tr>
<td>mapUnderscoreToCamelCase</td>
<td>是否开启自动驼峰命名规则映射，即从经典数据库列名 a_column 到属性名 aColumn的类似映射</td>
<td>true|false</td>
<td>false</td>
</tr>
<tr>
<td>localCacheScope</td>
<td>MyBatis利用本地缓存机制防止循环引用和加速重复嵌套查询。默认值为SESSION，这种情况下会缓存一个会话中执行的所有查询。若设置值为STATEMENT，本地会话仅用在语句执行上，对相同的SqlSession的不同调用将不会共享数据</td>
<td>SESSION|STATEMENT</td>
<td>SESSION</td>
</tr>
<tr>
<td>jdbcTypeForNull</td>
<td>当没有为参数提供特定的JDBC类型时，为空值指定JDBC类型。某些驱动需要指定列的JDBC类型，多数情况直接用一般类型即可，比如NULL、VARCHAR、OTHER</td>
<td>NULL、VARCHAR、OTHER</td>
<td>OTHER</td>
</tr>
<tr>
<td>lazyLoadTriggerMethods</td>
<td>指定那个对象的方法触发一次延迟加载</td>
<td></td>
<td>equals、clone、hashCode、toString</td>
</tr>
<tr>
<td>defaultScriptingLanguage</td>
<td>指定动态SQL生成的默认语言</td>
<td></td>
<td>org.apache.ibatis.scripting.xmltags.XMLDynamicLanguageDriver</td>
</tr>
<tr>
<td>callSettersOnNulls</td>
<td>指定当结果集中的值为null时，是否调用映射对象的setter方法，这对于有Map.keySet()依赖或者null值初始化时是有用的。注意，基本类型不能设置成null</td>
<td>true|false</td>
<td>false</td>
</tr>
<tr>
<td>logPrefix</td>
<td>指定MyBatis增加到日志名称的前缀</td>
<td>任何字符串</td>
<td>Not set</td>
</tr>
<tr>
<td>logImpl</td>
<td>指定MyBatis所用日志的记忆体实现，未指定时将自动查找</td>
<td>SLF4J、LOG4J、LOG4J2、JDK_LOGGING、COMMONS_LOGGING、STDOUT_LOGGING、NO_LOGGING</td>
<td>Not set</td>
</tr>
<tr>
<td>proxyFactory</td>
<td>指定MyBatis创建具有延迟加载能力的对象所用到的代理工具</td>
<td>CGLIB、JAVASSIST</td>
<td>JAVASSIST</td>
</tr>
<tr>
<td>vfsImpl</td>
<td>指定VFS的实现类</td>
<td>提供VFS类的权限定名，如果存在多个，可以用逗号分隔</td>
<td>Not set</td>
</tr>
<tr>
<td>useActualParamName</td>
<td>允许用方法参数中声明的实际名称引用参数</td>
<td>true|false</td>
<td>true</td>
</tr>
</tbody></table>
<h3 id="typeAliases设置"><a href="#typeAliases设置" class="headerlink" title="typeAliases设置"></a>typeAliases设置</h3><p>由于类的全限定名称很长，需要大量使用的时候，总写那么长的名称不方便，因此，允许用一个简写来代表这个类，这个简写就是别名。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">&quot;role&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.dougWilson.ssm.pojo.Role&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过上面的配置，就定义了一个别名。如果有许多类需要定义别名，则可以通过扫描别名。类似于Spring中的自动扫描，指定包，就会将包下的所有类，将其第一个字母变为小写作为其别名，比如Role的别名会变为role，而User的别名会变成user。但是，使用这样的规则，有时候会出现重名，比如扫描两个包，两个包中都有User类，那就会出现异常，这时候可以使用MyBatis提供的注解 <code>@Alias(&quot;user3&quot;)</code> 进行区分。这样可以避免因为别名重名而导致的扫描失败的问题。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.dougWilson.ssm.pojo&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.dougWilson.ssm.entity&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dougWilson.ssm.entity;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Alias(&quot;user3&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="typeHandler设置"><a href="#typeHandler设置" class="headerlink" title="typeHandler设置"></a>typeHandler设置</h3><p>typeHandler称为类型转换器。在JDBC中，需要在 <code>PreparedStatement</code> 对象中设置那些已经预编译过的SQL语句的参数。执行SQL后，会通过 <code>ResultSet</code> 对象获取得到数据库的数据，而这些 MyBatis 是根据数据的类型通过 typeHandler 来实现的。在 typeHandler中，分为 jdbcType 和 javaType，其中 jdbcType用于定义数据库类型，而 javaType 用于定义 Java 类型，那么typeHandler的作用就是承担 jdbcType 和 javaType 间的相互转换。</p>
<p>在多数情况下，并不需要去配置 typeHandler、jdbcType、javaType，因为 MyBatis会探测应该使用什么类型的typeHandler进行处理，但是有些场景无法探测到。对于那些需要使用自定义枚举的场景，或者数据库使用特殊数据类型的场景，可以使用自定义的typeHandler去处理类型间的转换问题。</p>
<p>系统定义的typeHandler:</p>
<table>
<thead>
<tr>
<th>类型处理器</th>
<th>Java类型</th>
<th>JDBC类型</th>
</tr>
</thead>
<tbody><tr>
<td>BooleanTypeHandler</td>
<td>java.lang.Boolean|boolean</td>
<td>数据库兼容的BOOLEAN</td>
</tr>
<tr>
<td>ByteTypeHandler</td>
<td>Byte|byte</td>
<td>数据库兼容的NUMERIC或BYTE</td>
</tr>
<tr>
<td>ShortTypeHandler</td>
<td>Short|short</td>
<td>数据库兼容的NUMERIC或SHORT INTEGER</td>
</tr>
<tr>
<td>IntegerTypeHandler</td>
<td>Integer|int</td>
<td>数据库兼容的NUMERIC或INTEGER</td>
</tr>
<tr>
<td>LongTypeHandler</td>
<td>Long|long</td>
<td>数据库兼容的NUMERIC或LONG INTEGER</td>
</tr>
<tr>
<td>FloatTypeHandler</td>
<td>Float|float</td>
<td>数据库兼容的NUMERIC或FLOAT</td>
</tr>
<tr>
<td>DoubleTypeHandler</td>
<td>Double|double</td>
<td>数据库兼容的NUMERIC或DOUBLE</td>
</tr>
<tr>
<td>BigDecimalTypeHandler</td>
<td>BigDecimal</td>
<td>数据库兼容的NUMERIC或DECIMAL</td>
</tr>
<tr>
<td>StringTypeHandler</td>
<td>String</td>
<td>CHAR、VARCHAR</td>
</tr>
<tr>
<td>ClobReaderTypeHandler</td>
<td>java.io.Reader</td>
<td></td>
</tr>
<tr>
<td>ClobTypeHandler</td>
<td>String</td>
<td>CLOB、LONGVARCHAR</td>
</tr>
<tr>
<td>NStringTypeHandler</td>
<td>String</td>
<td>NVARCHAR、NCHAR</td>
</tr>
<tr>
<td>NClobTypeHandler</td>
<td>String</td>
<td>NCLOB</td>
</tr>
<tr>
<td>BlobInputStreamTypeHandler</td>
<td>java.io.InputStream</td>
<td></td>
</tr>
<tr>
<td>ByteArrayTypeHandler</td>
<td>byte[]</td>
<td>数据库兼容的字节流类型</td>
</tr>
<tr>
<td>BlobTypeHandler</td>
<td>byte[]</td>
<td>BLOB、LONGVARBINARY</td>
</tr>
<tr>
<td>DateTypeHandler</td>
<td>java.util.Date</td>
<td>TIMESTAMP</td>
</tr>
<tr>
<td>DateOnlyTypeHandler</td>
<td>java.uti.Date</td>
<td>DATE</td>
</tr>
<tr>
<td>TimeOnlyTypeHandler</td>
<td>java.util.Time</td>
<td>TIME</td>
</tr>
<tr>
<td>SqlTimestampTypeHandler</td>
<td>java.sql.Timestamp</td>
<td>TIMESTAMP</td>
</tr>
<tr>
<td>SqlDateTypeHandler</td>
<td>java.sql.Date</td>
<td>DATE</td>
</tr>
<tr>
<td>SqlTimeTypeHandler</td>
<td>java.sql.Time</td>
<td>TIME</td>
</tr>
<tr>
<td>ObjectTypeHandler</td>
<td>Any</td>
<td>OTHER或未指定类型</td>
</tr>
<tr>
<td>EnumTypeHandler</td>
<td>Enumeration Type</td>
<td>VARCHAR任何兼容的字符串类型，存储枚举的名称</td>
</tr>
<tr>
<td>EnumOrdinalTypeHandler</td>
<td>Enumeration Type</td>
<td>任何兼容的NUMERIC或DOUBLE类型，存储枚举的索引</td>
</tr>
</tbody></table>
<h3 id="ObjectFactory（对象工厂）"><a href="#ObjectFactory（对象工厂）" class="headerlink" title="ObjectFactory（对象工厂）"></a>ObjectFactory（对象工厂）</h3><p>当创建结果集时，MyBatis会使用一个对象工厂来完成创建这个结果集实例。在默认情况下，MyBatis会使用其自定义的对象工厂—— <code>org.apache.ibatis.reflection.factory.DefaultObjectFactory</code> 来完成对应的工作。</p>
<p>MyBatis允许注册自定义的 ObjectFactory。 如果自定义，则需要实现接口 <code>org.apache.ibatis.reflection.factory.ObjectFactory</code> 并给予配置。大部分情况下，都不需要自定义返回规则，因为这些比较复杂并且容易出错，在更多情况下，会考虑基础系统已经实现好的 <code>DefaultObjectFactory</code>，通过一定的改写来完成所需要的工作。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyObjectFactory</span> <span class="keyword">extends</span> <span class="title">DefaultObjectFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8855122346740914948L</span>;</span><br><span class="line">    Long log = Logger.getLogger(MyObjectFactory.class);</span><br><span class="line">    privaet Object temp = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setProperties(properties);</span><br><span class="line">        log.info(<span class="string">&quot;初始化参数：[&quot;</span> + properties.toString() + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        T result = <span class="keyword">super</span>.create(type);</span><br><span class="line">        log.info(<span class="string">&quot;创建对象：&quot;</span> + result.toString());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt; type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class="line">        T result = <span class="keyword">super</span>.create(type, constructorArgTypes, constructorArgs);</span><br><span class="line">        log.info(<span class="string">&quot;创建对象：&quot;</span> + result.toString());</span><br><span class="line">        temp = result;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">isCollection</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.isCollection(type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后对它进行配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">objectFactory</span> <span class="attr">type</span>=<span class="string">&quot;com.dougWilson.ssm.objectFactory.MyObjectFactory&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prop1&quot;</span> <span class="attr">value</span>=<span class="string">&quot;value1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">objectFactory</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样，MyBatis就会采用配置的 <code>MyObjectFactory</code> 来生成结果集对象。</p>
<h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><p>先放在这，后面回来学习</p>
<h3 id="environments（运行环境）"><a href="#environments（运行环境）" class="headerlink" title="environments（运行环境）"></a>environments（运行环境）</h3><p>运行环境的主要作用是配置数据库信息，一般而言，它下面又会分为两个可配置的元素：事务管理器（transactionManager）、数据源（dataSource）。在实际的工作中，大部分情况下会采用 Spring 对数据源和数据库的事务进行管理。</p>
<h4 id="transactionManager"><a href="#transactionManager" class="headerlink" title="transactionManager"></a>transactionManager</h4><p>在MyBatis中，transactionManager提供两个实现类，需要实现接口 <code>org.apache.ibatis,transaction.Transaction</code>，该接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transaction</span> </span>&#123;</span><br><span class="line">    <span class="function">Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">Integer <span class="title">getTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个实现类为：<code>JdbcTransaction</code> 和 <code>ManagedTransaction</code> 。这两个实现类对应着两种工厂：JdbcTransactionFactory 和 ManagedTransactionFactory， 这个工厂需要实现 TransactionFactory 接口，通过它们会生成对应的 Transaction 对象。因此可以将事务管理器配置成以下两种方式：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;MANAGED&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>JDBC 使用 JdbcTransactionFactory 生成的 JdbcTransaction 对象实现。它是以 JDBC 的方式对数据库的提交和回滚进行操作</li>
<li>MANAGED 使用 ManagedTransactionFactory 生成的 ManagedTransaction 对象实现。它的提交和回滚方法不用任何操作，而是把事务交给容器处理。在默认情况下，它会关闭连接，然而一些容器并不希望这样，因此，需要将 closeConnection属性设置为 false 来阻止它的默认关闭行为</li>
</ul>
<h4 id="dataSource"><a href="#dataSource" class="headerlink" title="dataSource"></a>dataSource</h4><p>dataSource用于配置数据库。在MyBatis中，数据库通过 <code>PooledDataSourceFactory</code>、<code>UnpooledDataSourceFactory</code>、<code>JndiDataSourceFactory</code> 三个工厂类来提供，前两者对应产生 <code>PooledDataSource</code> 、<code>UnpooledDataSource</code> 类对象，而 <code>JndiDataSourceFactory</code> 则会根据 JNDI 的信息拿到外部容器实现的数据库连接对象。但是，无论如何，这三个工厂类，最后都会生成一个实现了DataSource接口的数据库连接对象。可以按照下面的方式配置它们：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;UNPOOLED&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;JNDI&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>UNPOOLED</p>
<p>UNPOOLED采用非数据库池的管理方式，每次请求都会打开一个新的数据库连接，所以创建会比较慢。UNPOOLED类型的数据源可以配置如下几种属性：</p>
<ul>
<li>driver 数据库驱动名</li>
<li>url 连接数据库的URL</li>
<li>username 用户名</li>
<li>password 密码</li>
<li>defaultTransactionIsolationLevel 默认的连接事务隔离级别</li>
</ul>
</li>
<li><p>POOLED</p>
<p>POOLED采用数据库连接池的管理方式，它开始会有一些空置并且连接好的数据库连接，所以请求时，无需再建立和验证，省去创建连接实例时所需要的初始化和认证时间。</p>
<p>它具备UPOOLED的属性，此外，还有以下属性：</p>
<ul>
<li>poolMaximumActiveConnections 在任意时间都存在的活动的连接数量，默认为10</li>
<li>poolMaximumIdleConnections 在任意时间可能存在的空闲连接数</li>
<li>poolMaximumCheckoutTime 在被强制返回前，连接池中被检出的时间，默认值为20秒</li>
<li>poolTimeToWait 如果获取连接花费相当长的时间，会给连接池打印默认状态并重新尝试获取一个连接，默认为20秒</li>
<li>poolPingQuery 检验连接是否处于正常的工作秩序中，并准备接收请求。默认为 “NO PING QUERY SET”，这会导致多数数据库驱动失败时带有一个恰当的错误消息</li>
<li>poolPingEnabled 是否启用侦测查询</li>
<li>poolPingConnectionsNotUsedFor 为配置poolPingQuery的使用频度，默认值为0，即所有连接的每一时刻都被侦测</li>
</ul>
</li>
<li><p>JNDI</p>
<p>数据源 JNDI 的实现是为了能在如EJB或应用服务器这类容器中使用，容器可以集中或在外部配置数据源，然后放置一个 JNDI 上下文的引用。这种数据源配置只需要两个属性：</p>
<ul>
<li>initial_context 在InitialContext中寻找上下文</li>
<li>data_source 引用数据源实例位置上下文的路径</li>
</ul>
</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/mybatis/" rel="tag"># mybatis</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/12/05/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99%E4%B8%8E%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="next" title="设计原则与设计模式">
                <i class="fa fa-chevron-left"></i> 设计原则与设计模式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/12/17/MyBatis%E6%98%A0%E5%B0%84%E5%99%A8/" rel="prev" title="MyBatis映射器">
                MyBatis映射器 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">80</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">73</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis%E7%B1%BB%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="nav-number">1.</span> <span class="nav-text">MyBatis类核心组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SqlSessionFactory%EF%BC%88%E5%B7%A5%E5%8E%82%E6%8E%A5%E5%8F%A3%EF%BC%89"><span class="nav-number">1.1.</span> <span class="nav-text">SqlSessionFactory（工厂接口）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8XML%E6%9E%84%E5%BB%BA-SqlSessionFactory"><span class="nav-number">1.1.1.</span> <span class="nav-text">使用XML构建 SqlSessionFactory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%A0%81%E5%88%9B%E5%BB%BASqlSessionFactory"><span class="nav-number">1.1.2.</span> <span class="nav-text">使用代码创建SqlSessionFactory</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SqlSession"><span class="nav-number">1.2.</span> <span class="nav-text">SqlSession</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL-Mapper%EF%BC%88%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%89"><span class="nav-number">1.3.</span> <span class="nav-text">SQL Mapper（映射器）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EXML%E5%AE%9A%E4%B9%89%E7%9A%84%E6%98%A0%E5%B0%84%E5%99%A8"><span class="nav-number">1.3.1.</span> <span class="nav-text">基于XML定义的映射器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E5%AE%9A%E4%B9%89%E7%9A%84%E6%98%A0%E5%B0%84%E5%99%A8"><span class="nav-number">1.3.2.</span> <span class="nav-text">基于注解定义的映射器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E9%80%81SQL"><span class="nav-number">1.4.</span> <span class="nav-text">发送SQL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SqlSession%E5%8F%91%E9%80%81SQL"><span class="nav-number">1.4.1.</span> <span class="nav-text">SqlSession发送SQL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Mapper%E6%8E%A5%E5%8F%A3%E5%8F%91%E9%80%81SQL"><span class="nav-number">1.4.2.</span> <span class="nav-text">Mapper接口发送SQL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%A4%E7%A7%8D%E5%8F%91%E9%80%81SQL%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="nav-number">1.4.3.</span> <span class="nav-text">两种发送SQL方式对比</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">1.5.</span> <span class="nav-text">生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SqlSessionFactoryBuilder"><span class="nav-number">1.5.1.</span> <span class="nav-text">SqlSessionFactoryBuilder</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SqlSessionFactory"><span class="nav-number">1.5.2.</span> <span class="nav-text">SqlSessionFactory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SqlSession-1"><span class="nav-number">1.5.3.</span> <span class="nav-text">SqlSession</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Mapper"><span class="nav-number">1.5.4.</span> <span class="nav-text">Mapper</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis%E9%85%8D%E7%BD%AE"><span class="nav-number">2.</span> <span class="nav-text">MyBatis配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#properties%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.1.</span> <span class="nav-text">properties设置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#property%E5%AD%90%E5%85%83%E7%B4%A0"><span class="nav-number">2.1.1.</span> <span class="nav-text">property子元素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8properties%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.2.</span> <span class="nav-text">使用properties文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Java%E4%BB%A3%E7%A0%81"><span class="nav-number">2.1.3.</span> <span class="nav-text">Java代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#settings%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.2.</span> <span class="nav-text">settings设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#typeAliases%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.3.</span> <span class="nav-text">typeAliases设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#typeHandler%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.4.</span> <span class="nav-text">typeHandler设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ObjectFactory%EF%BC%88%E5%AF%B9%E8%B1%A1%E5%B7%A5%E5%8E%82%EF%BC%89"><span class="nav-number">2.5.</span> <span class="nav-text">ObjectFactory（对象工厂）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%92%E4%BB%B6"><span class="nav-number">2.6.</span> <span class="nav-text">插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#environments%EF%BC%88%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%EF%BC%89"><span class="nav-number">2.7.</span> <span class="nav-text">environments（运行环境）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#transactionManager"><span class="nav-number">2.7.1.</span> <span class="nav-text">transactionManager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dataSource"><span class="nav-number">2.7.2.</span> <span class="nav-text">dataSource</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Doug-Wilson</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>





        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

  <!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>

   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
   <script type="text/javascript" src="/js/src/fireworks.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"model":{"jsonPath":"/live2dw/assets/Gantzert_Felixander.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
